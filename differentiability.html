<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Differentials & Differentiability Visualized</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: #f0f0f0;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: clamp(2.2rem, 5vw, 3.2rem);
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: clamp(1.1rem, 2vw, 1.4rem);
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .quote {
            font-style: italic;
            color: #a0d2eb;
            max-width: 800px;
            margin: 10px auto;
            padding: 15px;
            border-left: 3px solid #ff8a00;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 10px 10px 0;
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 25px;
        }
        
        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .visualization-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .visualization {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        #graph-container {
            height: 500px;
            position: relative;
            background: rgba(0, 10, 20, 0.7);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .explanation {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }
        
        h2 {
            font-size: clamp(1.6rem, 3vw, 2rem);
            margin-bottom: 20px;
            color: #ff8a00;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            font-size: clamp(1.4rem, 2.5vw, 1.8rem);
        }
        
        p {
            line-height: 1.8;
            margin-bottom: 20px;
            font-size: clamp(0.95rem, 1.8vw, 1.1rem);
        }
        
        .math {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            margin: 25px 0;
            border-left: 4px solid #ff8a00;
        }
        
        .equation {
            font-size: clamp(1.1rem, 2vw, 1.4rem);
            text-align: center;
            margin: 15px 0;
            font-family: 'Cambria Math', serif;
            color: #a0d2eb;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .control-group {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .control-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 138, 0, 0.3);
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #ff8a00;
            font-weight: 500;
            font-size: clamp(0.9rem, 1.8vw, 1rem);
        }
        
        input[type="range"] {
            width: 100%;
            margin-top: 5px;
            background: rgba(255, 138, 0, 0.3);
            height: 8px;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff8a00;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 138, 0, 0.5);
            transition: all 0.2s ease;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        
        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.5);
            color: #f0f0f0;
            border: 1px solid rgba(255, 138, 0, 0.5);
            font-size: clamp(0.9rem, 1.8vw, 1rem);
            margin-bottom: 15px;
        }
        
        button {
            background: linear-gradient(to right, #ff8a00, #e52e71);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: clamp(0.9rem, 1.8vw, 1rem);
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .value-display {
            text-align: center;
            font-size: clamp(1rem, 1.8vw, 1.1rem);
            margin-top: 5px;
            color: #a0d2eb;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: clamp(0.85rem, 1.8vw, 0.95rem);
        }
        
        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }
        
        .curve-color { background: #e52e71; }
        .tangent-color { background: #ff8a00; }
        .dx-color { background: #00c9ff; }
        .dy-color { background: #00ff95; }
        .delta-color { background: #ff6b6b; }
        
        .step-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .step {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .step:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: #ff8a00;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .step h3 {
            margin-bottom: 10px;
            color: #ff8a00;
            font-size: clamp(1rem, 1.8vw, 1.2rem);
        }
        
        .error-display {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            border-top: 2px solid #ff6b6b;
        }
        
        .error-display h3 {
            color: #ff6b6b;
            margin-bottom: 10px;
            font-size: clamp(1.1rem, 2vw, 1.3rem);
        }
        
        .error-values {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .error-value {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            min-width: 120px;
        }
        
        .error-value span {
            display: block;
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
        }
        
        .error-value .label {
            color: #a0d2eb;
            font-size: clamp(0.8rem, 1.6vw, 0.9rem);
        }
        
        .error-value .value {
            font-weight: bold;
            margin-top: 5px;
            font-size: clamp(1.1rem, 2vw, 1.3rem);
        }
        
        .function-info {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #a0d2eb;
        }
        
        /* Animation for the differentials */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        .panel-section {
            margin-bottom: 20px;
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            #graph-container {
                height: 400px;
            }
            
            .legend {
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            #graph-container {
                height: 350px;
            }
            
            .step-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Enhanced Differentials & Differentiability</h1>
            <p class="subtitle">Visualizing Infinitesimal Calculus with Interactive Functions</p>
            <p class="quote">"My calculus gave me, almost without meditation, the great part of the discoveries... it gives us the same advantages over the Ancients... freeing us from having to work with the imagination." - Leibniz</p>
        </header>
        
        <div class="main-content">
            <div class="visualization-container">
                <section class="visualization">
                    <h2><i class="fas fa-chart-line"></i> Visualization</h2>
                    <div id="graph-container">
                        <canvas id="graph" width="600" height="500"></canvas>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color curve-color"></div>
                            <span>Function Curve</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color tangent-color"></div>
                            <span>Tangent Line</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color dx-color"></div>
                            <span>dx (run)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color dy-color"></div>
                            <span>dy (rise)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color delta-color"></div>
                            <span>Δy (actual change)</span>
                        </div>
                    </div>
                    
                    <div class="error-display">
                        <h3>Approximation Error</h3>
                        <div class="error-values">
                            <div class="error-value">
                                <span class="label">Actual Δy</span>
                                <span class="value" id="delta-y-display">0.00</span>
                            </div>
                            <div class="error-value">
                                <span class="label">Differential dy</span>
                                <span class="value" id="dy-display">0.00</span>
                            </div>
                            <div class="error-value">
                                <span class="label">Error |Δy - dy|</span>
                                <span class="value" id="error-display">0.00</span>
                            </div>
                            <div class="error-value">
                                <span class="label">Relative Error</span>
                                <span class="value" id="relative-error-display">0.00%</span>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="explanation">
                    <h2><i class="fas fa-lightbulb"></i> Conceptual Explanation</h2>
                    
                    <div class="function-info">
                        <p>Current function: <strong><span id="current-function">y = x³</span></strong></p>
                        <p>Derivative: <strong><span id="derivative-function">dy/dx = 3x²</span></strong></p>
                    </div>
                    
                    <div class="math">
                        <p>For a function y = f(x), the differential dy is defined as:</p>
                        <div class="equation">dy = f'(x) dx</div>
                        <p>where dx is an infinitesimal change in x, and dy is the corresponding change in y along the tangent line.</p>
                    </div>
                    
                    <p>Differentials represent infinitesimal changes - quantities so small they approach zero but are not zero. They allow us to approximate changes in functions using linear relationships.</p>
                    
                    <p>In this visualization, we're examining the function <span id="function-name">y = x³</span>. The derivative is <span id="derivative-name">dy/dx = 3x²</span>. At x = <span id="x-value-text">2</span>, the derivative is <span id="derivative-value">12</span>.</p>
                    
                    <div class="step-container">
                        <div class="step">
                            <div class="step-number">1</div>
                            <h3>Original Point</h3>
                            <p>At x = <span id="step-x">2.0</span>, y = <span id="step-y">8.0</span></p>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <h3>New Point</h3>
                            <p>x + dx = <span id="step-x-dx">2.5</span>, y = <span id="step-y-new">15.625</span></p>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <h3>Differential</h3>
                            <p>dy = <span id="step-slope">12</span> × dx = <span id="step-dy">6.0</span></p>
                        </div>
                        <div class="step">
                            <div class="step-number">4</div>
                            <h3>Actual Change</h3>
                            <p>Δy = <span id="step-delta-y">7.625</span></p>
                        </div>
                    </div>
                    
                    <p>As dx approaches zero (try adjusting the slider or clicking "Animate dx → 0"), the tangent line becomes a better approximation of the actual function near the point. This is the essence of differentiability - the function can be locally approximated by a straight line.</p>
                    
                    <div class="math">
                        <p>Actual change in y:</p>
                        <div class="equation">Δy = f(x + dx) - f(x)</div>
                        <p>Approximation using differentials:</p>
                        <div class="equation">dy = f'(x) dx</div>
                        <p>As dx → 0, Δy ≈ dy with increasing accuracy:</p>
                        <div class="equation">\lim_{{dx \to 0}} \frac{{\Delta y - dy}}{{dx}} = 0</div>
                    </div>
                    
                    <p>Leibniz's differential notation provides an intuitive way to work with derivatives and integrals, transforming complex geometric problems into algebraic manipulations.</p>
                </section>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <div class="control-group-header">
                        <i class="fas fa-cog fa-2x"></i>
                        <h2>Function Controls</h2>
                    </div>
                    
                    <div class="panel-section">
                        <label for="function-select">Select Function:</label>
                        <select id="function-select">
                            <option value="x^2">y = x²</option>
                            <option value="x^3" selected>y = x³</option>
                            <option value="sin(x)">y = sin(x)</option>
                            <option value="e^x">y = eˣ</option>
                        </select>
                    </div>
                    
                    <div class="panel-section">
                        <div class="slider-container">
                            <label for="x-value">x-value: <span id="x-value-display">2.0</span></label>
                            <input type="range" id="x-value" min="0.5" max="3.5" step="0.01" value="2.0">
                        </div>
                        
                        <div class="slider-container">
                            <label for="dx-value">dx (Δx): <span id="dx-value-display">0.5</span></label>
                            <input type="range" id="dx-value" min="0.01" max="1.0" step="0.01" value="0.5">
                        </div>
                        
                        <div class="slider-container">
                            <label for="zoom">Zoom Level: <span id="zoom-display">1x</span></label>
                            <input type="range" id="zoom" min="1" max="5" step="0.1" value="1">
                        </div>
                        
                        <div class="slider-container">
                            <label for="animation">Animation Speed: <span id="animation-display">1.0</span></label>
                            <input type="range" id="animation" min="0" max="2" step="0.1" value="1">
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="reset-btn">
                            <i class="fas fa-sync-alt"></i> Reset Values
                        </button>
                        <button id="animate-btn">
                            <i class="fas fa-play-circle"></i> Animate dx → 0
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-group-header">
                        <i class="fas fa-info-circle fa-2x"></i>
                        <h2>Function Information</h2>
                    </div>
                    
                    <div class="function-info">
                        <h3>Current Function</h3>
                        <p><strong><span id="current-function-display">y = x³</span></strong></p>
                        <p>Derivative: <strong><span id="derivative-function-display">dy/dx = 3x²</span></strong></p>
                    </div>
                    
                    <div class="function-info">
                        <h3>Current Point</h3>
                        <p>x = <span id="current-x">2.0</span></p>
                        <p>y = <span id="current-y">8.0</span></p>
                        <p>f'(x) = <span id="current-slope">12.0</span></p>
                    </div>
                    
                    <div class="function-info">
                        <h3>Differentials</h3>
                        <p>dx = <span id="current-dx">0.5</span></p>
                        <p>dy = <span id="current-dy">6.0</span></p>
                        <p>Δy = <span id="current-delta-y">7.625</span></p>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-group-header">
                        <i class="fas fa-history fa-2x"></i>
                        <h2>Recent Changes</h2>
                    </div>
                    
                    <div class="function-info">
                        <ul style="padding-left: 20px;">
                            <li>Moved function controls to right panel</li>
                            <li>Integrated visualization and controls</li>
                            <li>Enhanced responsive design</li>
                            <li>Added real-time function info</li>
                            <li>Improved layout for all devices</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Get canvas context
        const canvas = document.getElementById('graph');
        const ctx = canvas.getContext('2d');
        
        // Set canvas to container size
        function resizeCanvas() {
            canvas.width = document.getElementById('graph-container').clientWidth;
            canvas.height = document.getElementById('graph-container').clientHeight;
        }
        
        resizeCanvas();
        
        // Initialize parameters
        let xValue = 2.0;
        let dxValue = 0.5;
        let zoomLevel = 1.0;
        let animationSpeed = 1.0;
        let currentFunction = 'x^3';
        let isAnimating = false;
        let animationId = null;
        
        // Function definitions
        const functions = {
            'x^2': {
                name: 'y = x²',
                derivative: 'dy/dx = 2x',
                fn: x => x * x,
                derivativeFn: x => 2 * x,
                xMin: -1,
                xMax: 4,
                yMin: -2,
                yMax: 16
            },
            'x^3': {
                name: 'y = x³',
                derivative: 'dy/dx = 3x²',
                fn: x => x * x * x,
                derivativeFn: x => 3 * x * x,
                xMin: -1,
                xMax: 4,
                yMin: -5,
                yMax: 70
            },
            'sin(x)': {
                name: 'y = sin(x)',
                derivative: 'dy/dx = cos(x)',
                fn: x => Math.sin(x),
                derivativeFn: x => Math.cos(x),
                xMin: 0,
                xMax: 2 * Math.PI,
                yMin: -1.5,
                yMax: 1.5
            },
            'e^x': {
                name: 'y = eˣ',
                derivative: 'dy/dx = eˣ',
                fn: x => Math.exp(x),
                derivativeFn: x => Math.exp(x),
                xMin: -1,
                xMax: 4,
                yMin: -1,
                yMax: 20
            }
        };
        
        // Coordinate conversion with zoom
        const padding = 60;
        
        function toCanvasX(x, func) {
            const range = (func.xMax - func.xMin) / zoomLevel;
            const center = (func.xMin + func.xMax) / 2;
            const zoomMin = center - range/2;
            const zoomMax = center + range/2;
            
            return padding + (x - zoomMin) / (zoomMax - zoomMin) * (canvas.width - 2 * padding);
        }
        
        function toCanvasY(y, func) {
            const range = (func.yMax - func.yMin) / zoomLevel;
            const center = (func.yMin + func.yMax) / 2;
            const zoomMin = center - range/2;
            const zoomMax = center + range/2;
            
            return canvas.height - padding - (y - zoomMin) / (zoomMax - zoomMin) * (canvas.height - 2 * padding);
        }
        
        // Draw coordinate system
        function drawAxes(func) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            
            // Determine step size based on zoom
            const xStep = zoomLevel < 2 ? 1 : 0.5;
            const yStep = zoomLevel < 2 ? 5 : 2;
            
            // Vertical grid lines
            for (let x = Math.floor(func.xMin); x <= Math.ceil(func.xMax); x += xStep) {
                ctx.beginPath();
                ctx.moveTo(toCanvasX(x, func), toCanvasY(func.yMin, func));
                ctx.lineTo(toCanvasX(x, func), toCanvasY(func.yMax, func));
                ctx.stroke();
            }
            
            // Horizontal grid lines
            for (let y = Math.floor(func.yMin); y <= Math.ceil(func.yMax); y += yStep) {
                ctx.beginPath();
                ctx.moveTo(toCanvasX(func.xMin, func), toCanvasY(y, func));
                ctx.lineTo(toCanvasX(func.xMax, func), toCanvasY(y, func));
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 2;
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(toCanvasX(func.xMin, func), toCanvasY(0, func));
            ctx.lineTo(toCanvasX(func.xMax, func), toCanvasY(0, func));
            ctx.stroke();
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(toCanvasX(0, func), toCanvasY(func.yMin, func));
            ctx.lineTo(toCanvasX(0, func), toCanvasY(func.yMax, func));
            ctx.stroke();
            
            // Draw axis labels
            ctx.fillStyle = '#f0f0f0';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            
            // X-axis labels
            for (let x = Math.floor(func.xMin); x <= Math.ceil(func.xMax); x += xStep) {
                if (x !== 0) {
                    ctx.fillText(x.toFixed(1), toCanvasX(x, func), toCanvasY(0, func) + 25);
                }
            }
            
            // Y-axis labels
            ctx.textAlign = 'right';
            for (let y = Math.floor(func.yMin); y <= Math.ceil(func.yMax); y += yStep) {
                if (y !== 0) {
                    ctx.fillText(y.toFixed(1), toCanvasX(0, func) - 10, toCanvasY(y, func) + 5);
                }
            }
            
            // Axis titles
            ctx.textAlign = 'center';
            ctx.fillText('x', canvas.width - 15, toCanvasY(0, func) - 10);
            ctx.textAlign = 'right';
            ctx.fillText('y', toCanvasX(0, func) - 10, 15);
        }
        
        // Draw the selected function
        function drawFunction(func) {
            ctx.beginPath();
            ctx.strokeStyle = '#e52e71';
            ctx.lineWidth = 3;
            
            const step = (func.xMax - func.xMin) / 200;
            for (let x = func.xMin; x <= func.xMax; x += step) {
                const y = func.fn(x);
                if (x === func.xMin) {
                    ctx.moveTo(toCanvasX(x, func), toCanvasY(y, func));
                } else {
                    ctx.lineTo(toCanvasX(x, func), toCanvasY(y, func));
                }
            }
            
            ctx.stroke();
        }
        
        // Draw tangent line at point x
        function drawTangent(xValue, dx, func) {
            const yValue = func.fn(xValue);
            const slope = func.derivativeFn(xValue);
            
            // Calculate two points for the tangent line
            const x1 = xValue - 0.8;
            const y1 = yValue - slope * 0.8;
            const x2 = xValue + 0.8;
            const y2 = yValue + slope * 0.8;
            
            ctx.beginPath();
            ctx.strokeStyle = '#ff8a00';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.moveTo(toCanvasX(x1, func), toCanvasY(y1, func));
            ctx.lineTo(toCanvasX(x2, func), toCanvasY(y2, func));
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw the point of tangency
            ctx.beginPath();
            ctx.fillStyle = '#ff8a00';
            ctx.arc(toCanvasX(xValue, func), toCanvasY(yValue, func), 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw dx and dy
            const x2Value = xValue + dx;
            const y2Actual = func.fn(x2Value);
            const dy = slope * dx;
            
            // dx line
            ctx.beginPath();
            ctx.strokeStyle = '#00c9ff';
            ctx.lineWidth = 3;
            ctx.moveTo(toCanvasX(xValue, func), toCanvasY(yValue, func));
            ctx.lineTo(toCanvasX(x2Value, func), toCanvasY(yValue, func));
            ctx.stroke();
            
            // dy line (differential)
            ctx.beginPath();
            ctx.strokeStyle = '#00ff95';
            ctx.lineWidth = 3;
            ctx.moveTo(toCanvasX(x2Value, func), toCanvasY(yValue, func));
            ctx.lineTo(toCanvasX(x2Value, func), toCanvasY(yValue + dy, func));
            ctx.stroke();
            
            // Actual change in y
            ctx.beginPath();
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 3;
            ctx.setLineDash([2, 3]);
            ctx.moveTo(toCanvasX(x2Value, func), toCanvasY(yValue + dy, func));
            ctx.lineTo(toCanvasX(x2Value, func), toCanvasY(y2Actual, func));
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw the new point on the curve
            ctx.beginPath();
            ctx.fillStyle = '#e52e71';
            ctx.arc(toCanvasX(x2Value, func), toCanvasY(y2Actual, func), 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw labels
            ctx.fillStyle = '#00c9ff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('dx', toCanvasX(xValue + dx/2, func), toCanvasY(yValue, func) + 20);
            
            ctx.fillStyle = '#00ff95';
            ctx.textAlign = 'left';
            ctx.fillText('dy', toCanvasX(x2Value, func) + 10, toCanvasY(yValue + dy/2, func));
            
            ctx.fillStyle = '#ff6b6b';
            ctx.textAlign = 'left';
            ctx.fillText('Δy', toCanvasX(x2Value, func) + 10, toCanvasY(yValue + dy + (y2Actual - yValue - dy)/2, func));
            
            // Display values
            ctx.fillStyle = '#f0f0f0';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`(${xValue.toFixed(2)}, ${yValue.toFixed(2)})`, toCanvasX(xValue, func), toCanvasY(yValue, func) - 15);
            ctx.fillText(`(${(xValue + dx).toFixed(2)}, ${y2Actual.toFixed(2)})`, toCanvasX(x2Value, func), toCanvasY(y2Actual, func) + 20);
            
            // Return values for error calculation
            return {
                deltaY: y2Actual - yValue,
                dy: dy,
                error: Math.abs((y2Actual - yValue) - dy),
                relativeError: Math.abs(((y2Actual - yValue) - dy) / (y2Actual - yValue)) * 100
            };
        }
        
        // Update display values
        function updateDisplays() {
            const func = functions[currentFunction];
            const xValue = parseFloat(document.getElementById('x-value').value);
            const dxValue = parseFloat(document.getElementById('dx-value').value);
            const zoom = parseFloat(document.getElementById('zoom').value);
            const animation = parseFloat(document.getElementById('animation').value);
            
            document.getElementById('x-value-display').textContent = xValue.toFixed(2);
            document.getElementById('dx-value-display').textContent = dxValue.toFixed(2);
            document.getElementById('zoom-display').textContent = zoom.toFixed(1) + 'x';
            document.getElementById('animation-display').textContent = animation.toFixed(1);
            
            // Update function information
            document.getElementById('current-function').textContent = func.name;
            document.getElementById('derivative-function').textContent = func.derivative;
            document.getElementById('function-name').textContent = func.name;
            document.getElementById('derivative-name').textContent = func.derivative;
            document.getElementById('current-function-display').textContent = func.name;
            document.getElementById('derivative-function-display').textContent = func.derivative;
            
            // Update step information
            const yValue = func.fn(xValue);
            const slope = func.derivativeFn(xValue);
            const dy = slope * dxValue;
            const newY = func.fn(xValue + dxValue);
            const deltaY = newY - yValue;
            const error = Math.abs(deltaY - dy);
            const relativeError = Math.abs((deltaY - dy) / deltaY) * 100;
            
            document.getElementById('derivative-value').textContent = slope.toFixed(2);
            document.getElementById('x-value-text').textContent = xValue.toFixed(1);
            
            document.querySelectorAll('#step-x').forEach(el => el.textContent = xValue.toFixed(1));
            document.getElementById('step-y').textContent = yValue.toFixed(2);
            document.getElementById('step-x-dx').textContent = (xValue + dxValue).toFixed(1);
            document.getElementById('step-y-new').textContent = newY.toFixed(3);
            document.getElementById('step-slope').textContent = slope.toFixed(2);
            document.getElementById('step-dy').textContent = dy.toFixed(2);
            document.getElementById('step-delta-y').textContent = deltaY.toFixed(3);
            
            // Update current values
            document.getElementById('current-x').textContent = xValue.toFixed(2);
            document.getElementById('current-y').textContent = yValue.toFixed(2);
            document.getElementById('current-slope').textContent = slope.toFixed(2);
            document.getElementById('current-dx').textContent = dxValue.toFixed(2);
            document.getElementById('current-dy').textContent = dy.toFixed(2);
            document.getElementById('current-delta-y').textContent = deltaY.toFixed(3);
            
            // Update error display
            document.getElementById('delta-y-display').textContent = deltaY.toFixed(4);
            document.getElementById('dy-display').textContent = dy.toFixed(4);
            document.getElementById('error-display').textContent = error.toFixed(4);
            document.getElementById('relative-error-display').textContent = relativeError.toFixed(2) + '%';
            
            return { deltaY, dy, error, relativeError };
        }
        
        // Main draw function
        function draw() {
            const func = functions[currentFunction];
            drawAxes(func);
            drawFunction(func);
            
            const xValue = parseFloat(document.getElementById('x-value').value);
            const dxValue = parseFloat(document.getElementById('dx-value').value);
            
            const errorInfo = drawTangent(xValue, dxValue, func);
            const displayInfo = updateDisplays();
            
            if (!isAnimating) {
                requestAnimationFrame(draw);
            }
        }
        
        // Animate dx going to zero
        function animateDxToZero() {
            if (isAnimating) return;
            
            isAnimating = true;
            const dxSlider = document.getElementById('dx-value');
            let dx = parseFloat(dxSlider.value);
            const startDx = dx;
            const duration = 3000; // ms
            const startTime = Date.now();
            
            function animateStep() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Exponential decay for smoother animation
                dx = startDx * Math.pow(0.001, progress);
                
                if (progress < 1) {
                    dxSlider.value = dx;
                    updateDisplays();
                    draw();
                    animationId = requestAnimationFrame(animateStep);
                } else {
                    dxSlider.value = 0.01;
                    updateDisplays();
                    draw();
                    isAnimating = false;
                }
            }
            
            animateStep();
        }
        
        // Reset to default values
        function resetValues() {
            document.getElementById('x-value').value = 2.0;
            document.getElementById('dx-value').value = 0.5;
            document.getElementById('zoom').value = 1.0;
            document.getElementById('animation').value = 1.0;
            zoomLevel = 1.0;
            animationSpeed = 1.0;
            updateDisplays();
            draw();
        }
        
        // Initialize
        document.getElementById('x-value').addEventListener('input', function() {
            draw();
        });
        
        document.getElementById('dx-value').addEventListener('input', function() {
            draw();
        });
        
        document.getElementById('zoom').addEventListener('input', function() {
            zoomLevel = parseFloat(this.value);
            draw();
        });
        
        document.getElementById('animation').addEventListener('input', function() {
            animationSpeed = parseFloat(this.value);
        });
        
        document.getElementById('function-select').addEventListener('change', function() {
            currentFunction = this.value;
            resetValues();
        });
        
        document.getElementById('reset-btn').addEventListener('click', resetValues);
        
        document.getElementById('animate-btn').addEventListener('click', animateDxToZero);
        
        window.addEventListener('resize', function() {
            resizeCanvas();
            draw();
        });
        
        // Initial draw
        resetValues();
        
        // Render math with KaTeX after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
        });
    </script>
</body>
</html>
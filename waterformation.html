<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Chemical Reaction Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0a192f, #0f1b2e, #14213d);
            color: #e6f1ff;
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        header {
            padding: 1rem 2rem;
            background: rgba(7, 20, 46, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(64, 224, 208, 0.25);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 30px rgba(0, 15, 30, 0.5);
            position: relative;
            z-index: 20;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2.2rem;
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 5px rgba(58, 123, 213, 0.6));
        }
        
        h1 {
            font-family: 'Exo 2', sans-serif;
            font-size: 1.9rem;
            font-weight: 700;
            background: linear-gradient(to right, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
        }
        
        .subtitle {
            font-size: 1.05rem;
            opacity: 0.85;
            max-width: 800px;
            margin-top: 0.3rem;
            line-height: 1.5;
            color: #a8d1ff;
        }
        
        .container {
            display: flex;
            flex: 1;
            padding: 1.5rem;
            gap: 1.8rem;
            max-height: calc(100vh - 80px);
        }
        
        #canvas-container {
            flex: 1;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 10, 30, 0.7);
            background: rgba(8, 25, 48, 0.35);
            position: relative;
            border: 1px solid rgba(64, 224, 208, 0.2);
        }
        
        #canvas-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(10, 80, 120, 0.1) 0%, rgba(5, 15, 30, 0.5) 70%);
            pointer-events: none;
            z-index: 1;
        }
        
        .controls {
            width: 340px;
            background: rgba(12, 35, 64, 0.65);
            border-radius: 16px;
            padding: 1.6rem;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(64, 224, 208, 0.25);
            display: flex;
            flex-direction: column;
            gap: 1.8rem;
            box-shadow: 0 10px 40px rgba(0, 10, 30, 0.6);
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }
        
        .control-group {
            background: rgba(18, 45, 80, 0.55);
            border-radius: 14px;
            padding: 1.4rem;
            border: 1px solid rgba(64, 224, 208, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .control-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
        }
        
        h2 {
            font-family: 'Exo 2', sans-serif;
            font-size: 1.3rem;
            margin-bottom: 1.2rem;
            color: #40e0d0;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid rgba(64, 224, 208, 0.2);
        }
        
        h2 i {
            font-size: 1.3rem;
            color: #3a7bd5;
        }
        
        .reaction-equation {
            text-align: center;
            font-size: 1.8rem;
            padding: 1.2rem;
            background: rgba(0, 40, 80, 0.45);
            border-radius: 12px;
            margin: 1.2rem 0;
            font-weight: bold;
            color: #7bf1e8;
            box-shadow: 0 5px 20px rgba(0, 20, 50, 0.4);
            position: relative;
            overflow: hidden;
            font-family: 'Exo 2', sans-serif;
            border: 1px solid rgba(64, 224, 208, 0.2);
        }
        
        .reaction-equation::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(123, 241, 232, 0.15), transparent);
            animation: shine 5s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            20% { left: 100%; }
            100% { left: 100%; }
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        button {
            flex: 1;
            background: linear-gradient(45deg, #0072ff, #00c6ff);
            border: none;
            color: #fff;
            padding: 0.9rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            box-shadow: 0 5px 20px rgba(0, 114, 255, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: 'Exo 2', sans-serif;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 114, 255, 0.6);
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        #reset-btn {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            box-shadow: 0 5px 20px rgba(255, 65, 108, 0.35);
        }
        
        #reset-btn:hover {
            box-shadow: 0 8px 25px rgba(255, 65, 108, 0.6);
        }
        
        .slider-container {
            margin: 1.2rem 0;
        }
        
        label {
            display: block;
            margin-bottom: 0.6rem;
            font-size: 0.95rem;
            opacity: 0.9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        label span {
            color: #40e0d0;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.08);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #40e0d0;
            cursor: pointer;
            box-shadow: 0 0 12px rgba(64, 224, 208, 0.8);
            border: 2px solid #0a192f;
        }
        
        .atom-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin: 1rem 0;
            padding: 0.9rem;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.06);
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .atom-info:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #40e0d0;
        }
        
        .atom-color {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.7rem;
            color: #0a192f;
        }
        
        .hydrogen { background: #FFFFFF; }
        .oxygen { background: #FF5252; }
        .bond { background: #AAAAAA; }
        
        .state-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(7, 20, 46, 0.85);
            padding: 0.9rem 1.6rem;
            border-radius: 30px;
            font-weight: 600;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(64, 224, 208, 0.3);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            z-index: 10;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            font-family: 'Exo 2', sans-serif;
        }
        
        .indicator-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ff5555;
            box-shadow: 0 0 10px #ff5555;
        }
        
        .indicator-dot.active {
            background: #7bf1e8;
            box-shadow: 0 0 15px #7bf1e8;
        }
        
        /* Enhanced Reaction Info Overlay */
        .reaction-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(7, 20, 46, 0.9);
            border-radius: 16px;
            padding: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.6;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(64, 224, 208, 0.35);
            z-index: 10;
            box-shadow: 0 10px 40px rgba(0, 15, 30, 0.6);
            max-width: 320px;
            transform: translateY(0);
            transition: transform 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            border-top: 4px solid #40e0d0;
        }
        
        .reaction-info:hover {
            transform: translateY(-5px);
        }
        
        .reaction-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border-radius: 16px 16px 0 0;
        }
        
        .reaction-info h3 {
            color: #40e0d0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-family: 'Exo 2', sans-serif;
            font-size: 1.3rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(64, 224, 208, 0.2);
        }
        
        .reaction-info p {
            margin-bottom: 1.2rem;
            color: #c3e6ff;
        }
        
        .energy-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 1rem;
            text-align: center;
        }
        
        .energy-card {
            background: rgba(10, 40, 80, 0.4);
            border-radius: 10px;
            padding: 0.8rem;
            border: 1px solid rgba(64, 224, 208, 0.2);
            transition: all 0.3s ease;
        }
        
        .energy-card:hover {
            transform: translateY(-3px);
            background: rgba(15, 50, 90, 0.5);
            box-shadow: 0 5px 15px rgba(0, 20, 50, 0.4);
        }
        
        .energy-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #7bf1e8;
            text-shadow: 0 0 12px rgba(123, 241, 232, 0.6);
            margin: 0.5rem 0;
            font-family: 'Exo 2', sans-serif;
        }
        
        .energy-label {
            font-size: 0.85rem;
            opacity: 0.85;
            color: #a8d1ff;
        }
        
        .footer {
            text-align: center;
            padding: 1.2rem;
            font-size: 0.85rem;
            opacity: 0.7;
            background: rgba(5, 15, 30, 0.7);
            font-family: 'Montserrat', sans-serif;
        }
        
        /* New visualization enhancements */
        .atom-glow {
            animation: glow-pulse 2s infinite alternate;
        }
        
        @keyframes glow-pulse {
            from { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8)); }
            to { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 1)); }
        }
        
        .molecule-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.07);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(64, 224, 208, 0.15);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px rgba(0, 20, 50, 0.3);
        }
        
        .stat-value {
            font-weight: bold;
            color: #40e0d0;
            font-size: 1.4rem;
            margin-top: 5px;
            font-family: 'Exo 2', sans-serif;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.85;
            color: #a8d1ff;
        }
        
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            
            .controls {
                width: 100%;
            }
            
            header {
                flex-direction: column;
                text-align: center;
                gap: 0.8rem;
            }
            
            .reaction-info {
                max-width: 100%;
                position: relative;
                top: 0;
                right: 0;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-icon">⚗️</div>
            <div>
                <h1>CHEMICAL REACTION SIMULATOR</h1>
                <p class="subtitle">Interactive 3D Visualization of Hydrogen Combustion: 2H₂ + O₂ → 2H₂O</p>
            </div>
        </div>
        <div class="header-info">
            <p>Exothermic Reaction | ΔH = -572 kJ/mol</p>
        </div>
    </header>
    
    <div class="container">
        <div id="canvas-container">
            <div class="state-indicator">
                <div class="indicator-dot active" id="state-dot"></div>
                <span id="state-text">Initial State: Reactants (2H₂ + O₂)</span>
            </div>
            
            <!-- Enhanced Reaction Info Overlay (top right) -->
            <div class="reaction-info">
                <h3>🔬 REACTION OVERVIEW</h3>
                <p>This simulation visualizes the formation of water through the combustion of hydrogen. Hydrogen molecules (H₂) react with oxygen (O₂) to form water (H₂O), releasing significant energy.</p>
                
                <div class="energy-display">
                    <div class="energy-card">
                        <div class="energy-label">H-H Bond Energy</div>
                        <div class="energy-value" id="bond-energy">436 kJ</div>
                    </div>
                    <div class="energy-card">
                        <div class="energy-label">Reaction Energy</div>
                        <div class="energy-value" id="reaction-energy">-572 kJ</div>
                    </div>
                    <div class="energy-card">
                        <div class="energy-label">O=O Bond Energy</div>
                        <div class="energy-value" id="bond-energy2">498 kJ</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h2>⚙️ REACTION CONTROLS</h2>
                <div class="reaction-equation">2H₂ + O₂ → 2H₂O</div>
                <div class="button-group">
                    <button id="start-btn">
                        <span>▶️</span> Start Reaction
                    </button>
                    <button id="reset-btn">
                        <span>🔄</span> Reset
                    </button>
                </div>
                <div class="slider-container">
                    <label for="speed-slider">
                        <span>Animation Speed</span>
                        <span id="speed-value">1.0x</span>
                    </label>
                    <input type="range" id="speed-slider" min="0.3" max="2" step="0.1" value="1">
                </div>
                
                <div class="molecule-stats">
                    <div class="stat-card">
                        <div class="stat-label">Molecules</div>
                        <div class="stat-value" id="molecule-count">3</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Atoms</div>
                        <div class="stat-value" id="atom-count">6</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bonds</div>
                        <div class="stat-value" id="bond-count">3</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Temperature</div>
                        <div class="stat-value" id="temperature">25°C</div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <h2>🎚️ VISUALIZATION SETTINGS</h2>
                <div class="slider-container">
                    <label for="camera-slider">
                        <span>Camera Distance</span>
                        <span id="camera-value">12 units</span>
                    </label>
                    <input type="range" id="camera-slider" min="5" max="20" step="1" value="12">
                </div>
                <div class="slider-container">
                    <label for="particle-slider">
                        <span>Particle Effects</span>
                        <span id="particle-value">High</span>
                    </label>
                    <input type="range" id="particle-slider" min="0" max="2" step="1" value="2">
                </div>
            </div>
            
            <div class="control-group">
                <h2>🧪 CHEMICAL ELEMENTS</h2>
                <div class="atom-info">
                    <div class="atom-color hydrogen">H</div>
                    <div>
                        <strong>Hydrogen (H)</strong>
                        <div>Color: White | Atomic Radius: 53 pm</div>
                    </div>
                </div>
                <div class="atom-info">
                    <div class="atom-color oxygen">O</div>
                    <div>
                        <strong>Oxygen (O)</strong>
                        <div>Color: Red | Atomic Radius: 60 pm</div>
                    </div>
                </div>
                <div class="atom-info">
                    <div class="atom-color bond">-</div>
                    <div>
                        <strong>Chemical Bonds</strong>
                        <div>Covalent electron sharing</div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <h2>📊 REACTION STAGES</h2>
                <div style="margin-top: 0.8rem;">
                    <div class="stage">
                        <div style="display: flex; align-items: center; margin-bottom: 0.8rem;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #ff5555; margin-right: 10px;"></div>
                            <div><strong>Bond Breaking</strong> - Energy absorption</div>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.8rem;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #ffaa00; margin-right: 10px;"></div>
                            <div><strong>Atom Rearrangement</strong> - Formation of intermediates</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #7bf1e8; margin-right: 10px;"></div>
                            <div><strong>Bond Formation</strong> - Energy release</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Created with Three.js | Advanced Chemical Reaction Visualization | Educational Demo
    </div>

    <script>
        // Main Three.js variables
        let scene, camera, renderer, controls;
        let atoms = [], bonds = [], particles = [];
        let animationId = null;
        let animationSpeed = 1;
        let particleDensity = 2;
        let animationState = 'initial'; // initial, breaking, rearranging, forming, complete
        
        // Atom properties
        const atomProperties = {
            'H': { radius: 0.5, color: 0xffffff, name: "Hydrogen" },
            'O': { radius: 0.8, color: 0xff5252, name: "Oxygen" }
        };
        
        // Reaction parameters
        const bondLength = 1.5;
        const bondAngle = 104.5 * (Math.PI / 180);
        const initialPositions = {
            h1: new THREE.Vector3(-4, 1.5, 0),
            h2: new THREE.Vector3(-5.5, 1.5, 0),
            o1: new THREE.Vector3(4, 0, 0),
            o2: new THREE.Vector3(5.5, 0, 0),
            h3: new THREE.Vector3(-4, -1.5, 0),
            h4: new THREE.Vector3(-5.5, -1.5, 0)
        };
        
        const waterPositions = {
            o1: new THREE.Vector3(-3, 2, 0),
            h1: new THREE.Vector3(-3 - bondLength * Math.cos(bondAngle/2), 2 + bondLength * Math.sin(bondAngle/2), 0),
            h2: new THREE.Vector3(-3 - bondLength * Math.cos(bondAngle/2), 2 - bondLength * Math.sin(bondAngle/2), 0),
            o2: new THREE.Vector3(3, -2, 0),
            h3: new THREE.Vector3(3 - bondLength * Math.cos(bondAngle/2), -2 + bondLength * Math.sin(bondAngle/2), 0),
            h4: new THREE.Vector3(3 - bondLength * Math.cos(bondAngle/2), -2 - bondLength * Math.sin(bondAngle/2), 0)
        };
        
        // Initialize the scene
        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a192f);
            scene.fog = new THREE.Fog(0x0a192f, 5, 25);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 15);
            
            // Create renderer
            const container = document.getElementById('canvas-container');
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            
            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const pointLight = new THREE.PointLight(0xffffff, 1, 100);
            pointLight.position.set(-5, 5, 5);
            scene.add(pointLight);
            
            const pointLight2 = new THREE.PointLight(0x40e0d0, 0.8, 50);
            pointLight2.position.set(0, -5, -5);
            scene.add(pointLight2);
            
            // Add stars background
            addStarfield();
            
            // Create initial molecules
            createInitialMolecules();
            
            // Add event listeners
            setupEventListeners();
            
            // Start animation loop
            animate();
        }
        
        // Add starfield background
        function addStarfield() {
            const starGeometry = new THREE.BufferGeometry();
            const starMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.15,
                transparent: true,
                sizeAttenuation: true
            });
            
            const starVertices = [];
            for (let i = 0; i < 3000; i++) {
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                const z = (Math.random() - 0.5) * 200;
                starVertices.push(x, y, z);
            }
            
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
        }
        
        // Create initial molecules (2H₂ and O₂)
        function createInitialMolecules() {
            // Clear existing atoms and bonds
            atoms.forEach(atom => scene.remove(atom));
            bonds.forEach(bond => scene.remove(bond));
            atoms = [];
            bonds = [];
            
            // Create hydrogen atoms (H₂)
            const h1 = createAtom('H', initialPositions.h1);
            const h2 = createAtom('H', initialPositions.h2);
            const h3 = createAtom('H', initialPositions.h3);
            const h4 = createAtom('H', initialPositions.h4);
            
            // Create oxygen atoms (O₂)
            const o1 = createAtom('O', initialPositions.o1);
            const o2 = createAtom('O', initialPositions.o2);
            
            // Create bonds
            bonds.push(createBond(h1, h2, 0.15)); // H-H bond
            bonds.push(createBond(h3, h4, 0.15)); // H-H bond
            
            // Create double bond for O2
            const oBond1 = createBond(o1, o2, 0.2);
            const oBond2 = createBond(o1, o2, 0.2);
            oBond2.position.y += 0.2; // Offset to simulate double bond
            
            bonds.push(oBond1, oBond2);
            
            // Store references to atoms
            atoms.push(h1, h2, h3, h4, o1, o2);
            
            // Update stats
            updateStats();
        }
        
        // Create an atom with enhanced material
        function createAtom(element, position) {
            const props = atomProperties[element];
            const geometry = new THREE.SphereGeometry(props.radius, 32, 32);
            const material = new THREE.MeshPhongMaterial({ 
                color: props.color,
                shininess: 100,
                emissive: new THREE.Color(props.color).multiplyScalar(0.15),
                specular: 0xffffff
            });
            
            const atom = new THREE.Mesh(geometry, material);
            atom.position.copy(position);
            atom.userData = { element: element, originalPosition: position.clone() };
            scene.add(atom);
            
            // Add glow effect
            const glow = new THREE.PointLight(props.color, 0.6, 4);
            atom.add(glow);
            
            return atom;
        }
        
        // Create a bond between two atoms
        function createBond(atom1, atom2, radius) {
            const midpoint = new THREE.Vector3().addVectors(atom1.position, atom2.position).multiplyScalar(0.5);
            const direction = new THREE.Vector3().subVectors(atom2.position, atom1.position);
            const length = direction.length();
            
            const geometry = new THREE.CylinderGeometry(radius, radius, length, 8);
            geometry.translate(0, length/2, 0);
            geometry.rotateX(Math.PI/2);
            
            const material = new THREE.MeshPhongMaterial({ 
                color: 0xaaaaaa,
                emissive: 0x444444,
                shininess: 80
            });
            
            const bond = new THREE.Mesh(geometry, material);
            bond.position.copy(midpoint);
            bond.lookAt(atom2.position);
            scene.add(bond);
            
            // Store references to the connected atoms
            bond.userData = { atom1: atom1, atom2: atom2 };
            
            return bond;
        }
        
        // Create energy particle
        function createParticle(position, color, size) {
            const geometry = new THREE.SphereGeometry(size, 10, 10);
            const material = new THREE.MeshBasicMaterial({ 
                color: color,
                transparent: true,
                opacity: 0.9
            });
            
            const particle = new THREE.Mesh(geometry, material);
            particle.position.copy(position);
            
            // Random velocity and direction
            particle.userData = {
                velocity: new THREE.Vector3(
                    (Math.random() - 0.5) * 0.15,
                    (Math.random() - 0.5) * 0.15,
                    (Math.random() - 0.5) * 0.15
                ),
                life: 1.0,
                decay: Math.random() * 0.02 + 0.01
            };
            
            scene.add(particle);
            particles.push(particle);
            return particle;
        }
        
        // Create energy wave effect
        function createEnergyWave(position, color) {
            const geometry = new THREE.RingGeometry(0.5, 1, 32);
            const material = new THREE.MeshBasicMaterial({
                color: color,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.8
            });
            
            const wave = new THREE.Mesh(geometry, material);
            wave.position.copy(position);
            wave.rotation.x = Math.PI / 2;
            
            scene.add(wave);
            
            // Animation properties
            wave.userData = {
                scaleSpeed: 0.06,
                fadeSpeed: 0.025
            };
            
            particles.push(wave);
            return wave;
        }
        
        // Start the chemical reaction animation
        function startReaction() {
            if (animationState !== 'initial' && animationState !== 'complete') return;
            
            animationState = 'breaking';
            document.getElementById('start-btn').disabled = true;
            document.getElementById('state-text').textContent = 'Bond Breaking - Energy Absorption';
            document.getElementById('bond-energy').textContent = "436 kJ";
            document.getElementById('bond-energy2').textContent = "498 kJ";
            document.getElementById('reaction-energy').textContent = "0 kJ";
            
            // Create initial energy waves
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    atoms.forEach(atom => {
                        createEnergyWave(atom.position.clone(), 0xff5555);
                    });
                }, i * 200);
            }
        }
        
        // Reset the reaction to initial state
        function resetReaction() {
            // Cancel any ongoing animation
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            // Remove particles
            particles.forEach(p => scene.remove(p));
            particles = [];
            
            // Reset animation state
            animationState = 'initial';
            
            // Recreate initial molecules
            createInitialMolecules();
            
            // Update UI
            document.getElementById('start-btn').disabled = false;
            document.getElementById('state-text').textContent = 'Initial State: Reactants (2H₂ + O₂)';
            document.getElementById('state-dot').className = 'indicator-dot active';
            document.getElementById('bond-energy').textContent = "436 kJ";
            document.getElementById('bond-energy2').textContent = "498 kJ";
            document.getElementById('reaction-energy').textContent = "-572 kJ";
            
            // Restart animation loop
            animate();
        }
        
        // Animation progress variables
        let progress = 0;
        let waterMolecules = [];
        
        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Update controls
            controls.update();
            
            // Rotate all atoms slowly for visual effect
            atoms.forEach(atom => {
                atom.rotation.x += 0.003 * animationSpeed;
                atom.rotation.y += 0.004 * animationSpeed;
            });
            
            // Update particles
            updateParticles();
            
            // Handle different animation states
            switch (animationState) {
                case 'breaking':
                    progress += 0.008 * animationSpeed;
                    
                    // Stretch bonds
                    bonds[0].scale.y = 1 + progress * 2; // H-H bond
                    bonds[1].scale.y = 1 + progress * 2; // H-H bond
                    bonds[2].scale.y = 1 + progress;      // O-O bond
                    bonds[3].scale.y = 1 + progress;      // O-O bond
                    
                    // Add vibration effect
                    bonds[0].position.y += Math.sin(Date.now() * 0.01) * 0.05 * progress;
                    bonds[1].position.y += Math.sin(Date.now() * 0.01 + 1) * 0.05 * progress;
                    bonds[2].position.y += Math.sin(Date.now() * 0.01 + 2) * 0.05 * progress;
                    bonds[3].position.y += Math.sin(Date.now() * 0.01 + 3) * 0.05 * progress;
                    
                    // Create energy particles
                    if (particleDensity > 0 && Math.random() < 0.3 * particleDensity) {
                        bonds.forEach(bond => {
                            const pos = bond.position.clone();
                            pos.x += (Math.random() - 0.5) * 0.5;
                            pos.y += (Math.random() - 0.5) * 0.5;
                            createParticle(pos, 0xff5555, 0.12);
                        });
                    }
                    
                    if (progress > 1) {
                        // Remove original bonds
                        bonds.forEach(bond => scene.remove(bond));
                        bonds = [];
                        
                        // Move to next state
                        animationState = 'rearranging';
                        document.getElementById('state-text').textContent = 'Atom Rearrangement - Formation of Intermediates';
                        document.getElementById('state-dot').className = 'indicator-dot';
                        document.getElementById('state-dot').style.background = "#ffaa00";
                        document.getElementById('state-dot').style.boxShadow = "0 0 15px #ffaa00";
                        document.getElementById('reaction-energy').textContent = "-286 kJ";
                        progress = 0;
                    }
                    break;
                    
                case 'rearranging':
                    progress += 0.006 * animationSpeed;
                    
                    // Move hydrogen atoms to form water
                    atoms[0].position.lerp(waterPositions.h1, progress);
                    atoms[1].position.lerp(waterPositions.h2, progress);
                    atoms[2].position.lerp(waterPositions.h3, progress);
                    atoms[3].position.lerp(waterPositions.h4, progress);
                    
                    // Move oxygen atoms
                    atoms[4].position.lerp(waterPositions.o1, progress);
                    atoms[5].position.lerp(waterPositions.o2, progress);
                    
                    // Create particles
                    if (particleDensity > 0 && Math.random() < 0.2 * particleDensity) {
                        atoms.forEach(atom => {
                            if (Math.random() > 0.7) {
                                const pos = atom.position.clone();
                                createParticle(pos, 0xffaa00, 0.1);
                            }
                        });
                    }
                    
                    if (progress > 1) {
                        // Create water molecules
                        waterMolecules = [
                            { o: atoms[4], h1: atoms[0], h2: atoms[1] },
                            { o: atoms[5], h1: atoms[2], h2: atoms[3] }
                        ];
                        
                        // Move to next state
                        animationState = 'forming';
                        document.getElementById('state-text').textContent = 'Bond Formation - Energy Release';
                        document.getElementById('state-dot').style.background = "#7bf1e8";
                        document.getElementById('state-dot').style.boxShadow = "0 0 15px #7bf1e8";
                        document.getElementById('reaction-energy').textContent = "-572 kJ";
                        progress = 0;
                        
                        // Create energy waves
                        for (let i = 0; i < 8; i++) {
                            setTimeout(() => {
                                waterMolecules.forEach(mol => {
                                    createEnergyWave(mol.o.position.clone(), 0x7bf1e8);
                                });
                            }, i * 150);
                        }
                    }
                    break;
                    
                case 'forming':
                    progress += 0.01 * animationSpeed;
                    
                    // Create bonds with growing effect
                    if (bonds.length === 0) {
                        waterMolecules.forEach(water => {
                            const bond1 = createBond(water.o, water.h1, 0.15);
                            const bond2 = createBond(water.o, water.h2, 0.15);
                            
                            // Set initial scale to 0 for growing effect
                            bond1.scale.y = 0;
                            bond2.scale.y = 0;
                            
                            bonds.push(bond1, bond2);
                        });
                    }
                    
                    // Grow bonds
                    bonds.forEach(bond => {
                        bond.scale.y = progress;
                        
                        // Add glow effect
                        const glow = Math.sin(progress * Math.PI) * 0.3;
                        bond.material.emissive.setRGB(glow, glow, glow);
                    });
                    
                    // Create energy particles
                    if (particleDensity > 0) {
                        const particleCount = progress < 0.5 ? 1 : 2;
                        for (let i = 0; i < particleCount * particleDensity; i++) {
                            bonds.forEach(bond => {
                                if (Math.random() > 0.5) {
                                    const pos = bond.position.clone();
                                    pos.x += (Math.random() - 0.5) * 0.8;
                                    pos.y += (Math.random() - 0.5) * 0.8;
                                    createParticle(pos, 0x7bf1e8, 0.18);
                                }
                            });
                        }
                    }
                    
                    if (progress > 1) {
                        // Animation complete
                        animationState = 'complete';
                        document.getElementById('state-text').textContent = 'Reaction Complete - Products (2H₂O)';
                        
                        // Add completion effect - pulsation
                        setInterval(() => {
                            bonds.forEach(bond => {
                                bond.material.emissive.setHex(Math.random() > 0.5 ? 0x229966 : 0x33aa88);
                            });
                        }, 500);
                        
                        // Update stats
                        updateStats();
                    }
                    break;
            }
            
            renderer.render(scene, camera);
        }
        
        // Update particles
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                
                // Handle different particle types
                if (p.geometry.type === 'RingGeometry') {
                    // Energy wave effect
                    p.scale.x += p.userData.scaleSpeed;
                    p.scale.y += p.userData.scaleSpeed;
                    p.material.opacity -= p.userData.fadeSpeed;
                    
                    if (p.material.opacity <= 0) {
                        scene.remove(p);
                        particles.splice(i, 1);
                    }
                } else {
                    // Regular particle
                    p.userData.life -= p.userData.decay;
                    
                    if (p.userData.life <= 0) {
                        scene.remove(p);
                        particles.splice(i, 1);
                        continue;
                    }
                    
                    // Update position
                    p.position.add(p.userData.velocity);
                    
                    // Fade out
                    p.material.opacity = p.userData.life * 0.8;
                    
                    // Shrink
                    p.scale.multiplyScalar(0.97);
                }
            }
        }
        
        // Update statistics display
        function updateStats() {
            const moleculeCount = animationState === 'complete' ? 2 : 3;
            const bondCount = animationState === 'complete' ? 4 : 4;
            const temperature = animationState === 'complete' ? '85°C' : '25°C';
            
            document.getElementById('molecule-count').textContent = moleculeCount;
            document.getElementById('atom-count').textContent = atoms.length;
            document.getElementById('bond-count').textContent = bondCount;
            document.getElementById('temperature').textContent = temperature;
        }
        
        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('start-btn').addEventListener('click', startReaction);
            document.getElementById('reset-btn').addEventListener('click', resetReaction);
            
            document.getElementById('speed-slider').addEventListener('input', (e) => {
                animationSpeed = parseFloat(e.target.value);
                document.getElementById('speed-value').textContent = animationSpeed.toFixed(1) + 'x';
            });
            
            document.getElementById('camera-slider').addEventListener('input', (e) => {
                const z = parseFloat(e.target.value);
                camera.position.z = z;
                document.getElementById('camera-value').textContent = z + ' units';
            });
            
            document.getElementById('particle-slider').addEventListener('input', (e) => {
                particleDensity = parseInt(e.target.value);
                const labels = ['Off', 'Medium', 'High'];
                document.getElementById('particle-value').textContent = labels[particleDensity];
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                const container = document.getElementById('canvas-container');
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }
        
        // Start the application
        init();
    </script>
</body>
</html>
